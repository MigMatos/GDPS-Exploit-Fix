<html>
<head>
<title>LEVEL REUPLOAD</title>
</head>
<body>
<?php
function chkarray($source, $default = 0){
	if($source == ""){
		$target = $default;
	}else{
		$target = $source;
	}
	return $target;
}
//error_reporting(0);
include "../incl/lib/connection.php";
require "../incl/lib/XORCipher.php";
require "../config/reuploadAcc.php";
require_once "../incl/lib/mainLib.php";
require_once "../incl/lib/generatePass.php";
require_once "../incl/lib/Captcha.php";
require_once "../incl/lib/exploitPatch.php";

$gs = new mainLib();

if(!empty($_POST["levelid"])){
	if (!Captcha::validateCaptcha()) {
		exit("Invalid captcha response");
	}
	if (!empty($_POST["user"]) and !empty($_POST["pass"])) {
		$userhere = ExploitPatch::remove($_POST["user"]);
		$passhere = ExploitPatch::remove($_POST["pass"]);
		$passed_g = GeneratePass::isValidUsrname($userhere, $passhere);
		if ($passed_g == 1) {
			$query = $db->prepare("SELECT isAdmin FROM accounts WHERE userName = :user");
			$query->execute([':user' => $userhere]);
			$userInfo = $query->fetchAll()[0];
			$admin_mode = (int) $userInfo["isAdmin"];
			if ($admin_mode == 1) {
				echo "Admin mode!<br>";
			}
			else{
				echo "Admin perms denegated!<br>";
				$admin_mode = 0;
			}
		}
		else{
			echo "Password or Username incorrect!<br>";
			$admin_mode = 0;
		}
	} else
	{
		$admin_mode = 0;
	}
	$levelID = $_POST["levelid"];
	$levelID = preg_replace("/[^0-9]/", '', $levelID);
	$url = $_POST["server"].$_POST["server_path"];
	$post = ['gameVersion' => '21', 'binaryVersion' => '33', 'gdw' => '0', 'levelID' => $levelID, 'secret' => 'Wmfd2893gb7', 'inc' => '1', 'extras' => '0'];
	$ch = curl_init($url);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
	curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
	curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);
	$result = curl_exec($ch);
	curl_close($ch);
	if($result == "" OR $result == "-1" OR $result == "No no no"){
		if($result==""){
			echo "An error has occured while connecting to the server.";
		}else if($result=="-1"){
			echo "This level doesn't exist.";
		}else{
			echo "RobTop doesn't like you or something...";
		}
		echo "<br>Error code: $result";
		die();
	}else{
		$level = explode('#', $result)[0];
		$resultarray = explode(':', $level);
		$levelarray = array();
		$x = 1;
		foreach($resultarray as &$value){
			if ($x % 2 == 0) {
				$levelarray["a$arname"] = $value;
			}else{
				$arname = $value;
			}
			$x++;
		}
		//echo $result;
		if($_POST["debug"] == 1){
			echo "<br>".$result . "<br>";
			var_dump($levelarray);
		}
		if($levelarray["a4"] == ""){
			echo "Reuploads from this server have been blocked or you have not placed the URL correctly. <br>Debug: ".htmlspecialchars($result,ENT_QUOTES);
			die();
		}
		$uploadDate = time();
		//old levelString
		$levelString = chkarray($levelarray["a4"]);
		$gameVersion = chkarray($levelarray["a13"]);
		if(substr($levelString,0,2) == 'eJ'){
			$levelString = str_replace("_","/",$levelString);
			$levelString = str_replace("-","+",$levelString);
			$levelString = gzuncompress(base64_decode($levelString));
			if($gameVersion > 18){
				$gameVersion = 18;
			}
		}
		//check if exists
		$query = $db->prepare("SELECT count(*) FROM levels WHERE originalReup = :lvl OR original = :lvl");
		$query->execute([':lvl' => $levelarray["a1"]]);
		if($query->fetchColumn() == 0){
			$parsedurl = parse_url($url);
			if($parsedurl["host"] == $_SERVER['SERVER_NAME']){
				exit("You're attempting to reupload from the target server.");
			}
			$hostname = $gs->getIP();
			//values
			$twoPlayer = chkarray($levelarray["a31"]);
			$songID = chkarray($levelarray["a35"]);
			$coins = chkarray($levelarray["a37"]);
			$reqstar = chkarray($levelarray["a39"]);
			$extraString = chkarray($levelarray["a36"], "");
			$starStars = chkarray($levelarray["a18"]);
			$isLDM = chkarray($levelarray["a40"]);
			$password = chkarray($levelarray["a27"]);
			if($password != "0"){
				$password = XORCipher::cipher(base64_decode($password),26364);
			}
			$starCoins = 0;
			$starDiff = 0;
			$starDemon = 0;
			$starAuto = 0;
			if($parsedurl["host"] == "www.boomlings.com"){
				if($starStars != 0){
					$starCoins = chkarray($levelarray["a38"]);
					$starDiff = chkarray($levelarray["a9"]);
					$starDemon = chkarray($levelarray["a17"]);
					$starAuto = chkarray($levelarray["a25"]);
				}
			}else{
				$starStars = 0;
			}
			$targetUserID = chkarray($levelarray["a6"]);
			//linkacc
			
			$query = $db->prepare("SELECT accountID, userID, timestamp FROM links WHERE targetUserID=:target AND server=:url");
			$query->execute([':target' => $targetUserID, ':url' => $parsedurl["host"]]);
			
			if($query->rowCount() == 0){
				if ($admin_mode == 1){
					$userID = $reupUID;
					$extID = $reupAID;
					$timestamp_reupload = time() - 1000;
				} else {
					echo "<br><br><h3><a href='linkAcc.php'>You do not own this level and it cannot be reuploaded, link an account in linkAcc.php</a></h3><br><br>";
					die();
				}
			}else{
				$userInfo = $query->fetchAll()[0];
				$userID = $userInfo["userID"];
				$extID = $userInfo["accountID"];
				if ($admin_mode == 1) {
					$timestamp_reupload = time() - 1000;
				}
				else{
					$timestamp_reupload = (int) $userInfo["timestamp"];
				}
			}
			if (time() <= $timestamp_reupload){
				$wait_time = $timestamp_reupload - time();
				echo "<h2>You need wait $wait_time seconds to reupload level again!</h2><br><br>";
				die();
			} else {
				$reupCooldown = 43200;//12 hrs cooldown
				//query
				if ($admin_mode == 0){
					$cooldown_reupload = $timestamp_reupload + $reupCooldown;
					echo "Cooldown: $cooldown_reupload";
					$sucess_query = $db->prepare("UPDATE links SET timestamp = :timestamp WHERE targetUserID = :target AND server=:url");
					$sucess_query->execute([':target' => $targetUserID, ':url' => $parsedurl["host"], ':timestamp' => $cooldown_reupload]);

				} else {
					$sucess_query = true;
				}
				if ($sucess_query) {
					$query = $db->prepare("INSERT INTO levels (levelName, gameVersion, binaryVersion, userName, levelDesc, levelVersion, levelLength, audioTrack, auto, password, original, twoPlayer, songID, objects, coins, requestedStars, extraString, levelString, levelInfo, secret, uploadDate, updateDate, originalReup, userID, extID, unlisted, hostname, starStars, starCoins, starDifficulty, starDemon, starAuto, isLDM)
												VALUES (:name ,:gameVersion, '27', 'Reupload', :desc, :version, :length, :audiotrack, '0', :password, :originalReup, :twoPlayer, :songID, '0', :coins, :reqstar, :extraString, :levelString, '', '', '$uploadDate', '$uploadDate', :originalReup, :userID, :extID, '0', :hostname, :starStars, :starCoins, :starDifficulty, :starDemon, :starAuto, :isLDM)");
					$query->execute([':password' => $password, ':starDemon' => $starDemon, ':starAuto' => $starAuto, ':gameVersion' => $gameVersion, ':name' => $levelarray["a2"], ':desc' => $levelarray["a3"], ':version' => $levelarray["a5"], ':length' => $levelarray["a15"], ':audiotrack' => $levelarray["a12"], ':twoPlayer' => $twoPlayer, ':songID' => $songID, ':coins' => $coins, ':reqstar' => $reqstar, ':extraString' => $extraString, ':levelString' => "", ':originalReup' => $levelarray["a1"], ':hostname' => $hostname, ':starStars' => $starStars, ':starCoins' => $starCoins, ':starDifficulty' => $starDiff, ':userID' => $userID, ':extID' => $extID, ':isLDM' => $isLDM]);
					$levelID = $db->lastInsertId();
					file_put_contents("../data/levels/$levelID", $levelString);
					echo "<h1>Level reuploaded!</h1><br><h2>ID: $levelID</h2><br><hr><br>";
				}else{
					echo "<h1>Error!</h1><br><h2>Error in update info!</h2><br><br>";
				}
			}
		}else{
			echo "<h1>Error!</h1><br><h2>This level has been already reuploaded!</h2><br><br>";
		}
	}
}else{
	echo '<body style="background-color:black;color:white;"><h2><a href="linkAcc.php">LINKING YOUR ACCOUNT USING linkAcc.php</a></h2><br>
		<form action="levelReupload.php" method="post">ID: <input type="text" name="levelid"><br>
		<details>
		    <summary>Advanced options</summary>
			URL Server: <input type="text" name="server" value="http://www.boomlings.com/database/"><br>
			downloadGJLevel22.php or similar Path: <input type="text" name="server_path" value="downloadGJLevel22.php"><br>
			Debug Mode (0=off, 1=on): <input type="text" name="debug" value="0"><br>
		</details>
		<br>
		<details>
		    <summary>Admin reuploads</summary>
			Username: <input type="text" name="user" value=""><br>
			Password: <input type="password" name="pass" value=""><br>
		</details>
		<br>';
		Captcha::displayCaptcha();
	echo '<input type="submit" value="Reupload level"></form>';
}
?>
</body>
</html>
