<?php
include_once dirname(__FILE__)."/mainLib.php";

/*
        Codes
    -700 Levels
    -701 Accounts
    -705 Accounts Tools
    -702 Comments
    -703 Timeouted
*/

//Class
class TimeoutCheck {



    public static function NoTimeoutOrDie($ip, $code_timeout)
    {
        include dirname(__FILE__)."/connection.php";


        //  Timeouts Config
        
        $timeout_levels = 60;
        $timeout_accounts = 200;
        $timeout_comments = 60;
        $max_errors_timeout = 50;
        $global_timeout = 500;
        #$max_request_per_day = 30;

        if ($code_timeout == -700) {
            $timeout = $timeout_levels;
        }
        elseif ($code_timeout == -701 || $code_timeout == -705) {
            $timeout = $timeout_accounts;
        }
        elseif ($code_timeout == -702) {
            $timeout = $timeout_comments;
        }
        elseif ($code_timeout == -703) {
            $timeout = 86400;
        }
        else{
            $timeout = $global_timeout;
        }
        
        $next_timestamp = time() - $timeout;
		$query = $db->prepare("SELECT count(*) FROM actions WHERE type = :codetimeout AND timestamp >= :timestamp");
		$query->execute([':codetimeout' => $code_timeout,':timestamp' => $next_timestamp]);
        $data = $query->fetchColumn();
        echo "<br>Sucess! -> data: $data with $code_timeout with next_timestamp: $next_timestamp";

        if($code_timeout == -703 && $data >= $max_errors_timeout){
            exit("-1");
        }
        elseif($code_timeout == -705 && $data >= 1){
            self::InsertTimeout($ip, -703);
            exit("<br><h2>Please wait $timeout seconds before registering another account</h2>");
        }
        elseif($code_timeout != -703 && $data >= 1){
            self::InsertTimeout($ip, -703);
            exit("-1");
		}
    }

    public static function InsertTimeout($ip, $code_timeout){
        include dirname(__FILE__)."/connection.php";
        $message = "Timeout Checker AntiRaid";
        if ($code_timeout == -700) {$message = "Timeout Level";}
        elseif ($code_timeout == -701 || $code_timeout == -705) {$message = "Timeout Accounts";}
        elseif ($code_timeout == -702) {$message = "Timeout Comments";}
        elseif ($code_timeout == -703) {$message = "Timeout Error";} 
        else {$message = "Timeout Unknown";}
        $query = $db->prepare("INSERT INTO actions (type, value, value2, timestamp) VALUES (:codetimeout, :ip, :history, :timestamp)");
		$query->execute([':codetimeout' => $code_timeout, ':ip' => $ip,':history' => $message, ':timestamp' => time()-5]);
    }

    public static function CheckTimeout($code_timeout){
        $ml = new mainLib();
        $ip = $ml->getIP();
        self::NoTimeoutOrDie($ip, -703);
        self::NoTimeoutOrDie($ip, $code_timeout);
        self::InsertTimeout($ip, $code_timeout);
    }

}

?>
